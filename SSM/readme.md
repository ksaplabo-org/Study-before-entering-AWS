# Session Manager

今回はSSMとは何か。というより、豆知識的な内容である。

## Session Managerのログ有効化

実際の開発現場では、操作ログを残すためにEC2インスタンスにSSM接続を行う際は、SSMのログを残す場合がほとんどだと思われる。  
(接続後、誰がどんなコマンドを実行したのかログで残る。)  


### S3バケットにログを保存する場合

以下の設定を行う。
- SSMの設定画面から「S3 Logging」を有効化
- EC2インスタンスに使用しているIAM Roleにログの保存先のS3バケットに対する権限を付与

上記の設定の他に、EC2インスタンスのセキュリティグループのアウトバウンドルールは  
全ての送信先に対して許可されている設定が入ることで、S3バケットにログを保存することが可能になる。  

では、AWSのベストプラクティス的にアウトバウンドルールを全て許可することがNGとなった場合  
どのような対応を取ることができるのか  

### プレフィックスリスト

セキュリティグループのアウトバウンドルールで指定できるものは以下の３つである。  
- CIDRブロック
- セキュリティグループ
- プレフィックスリスト

ここでは、「プレフィックスリスト」を使用する。  
マネジメントコンソールから、VPC > マネージドプレフィックスリストで、プレフィックスリストの一覧を参照することができる。  

```
プレフィックスリストとは
　複数のCIDRブロックをまとめたもの

プレフィックスリストには以下の２種類がある
・AWSマネージドプレフィックスリスト：AWSが用意してくれているプレフィックス
・カスタマー管理プレフィックス：自分で作成するプレフィックス
```

セキュリティグループのアウトバウンドルールでS3を指定したい場合、マネージドプレフィックスにあるS3のプレフィックスを指定することで  
ログの送信が可能になる。  
  

### CloudWatch Log Groupにログを保存する場合

この場合も最初は同様にSSMの設定画面から有効化を行い、IAM Roleに権限を付与して  
アウトバウンドルールを全て許可に設定することで、ログが送信される。  

ただ、アウトバウンドルールに制約を入れると、S3と同様の対応が出来なくなる。  
→なぜか  
- AWSマネージドプレフィックスリストにCloudWatch Log Group用のものが存在しないため

考えられる対応①  
```
CWL Group用のカスタマー管理プレフィックスリストを作成する
```
これは調査した限り不可能であった。
→ curl -s http://ip-ranges.amazonaws.com/ip-ranges.json  
このコマンドで、AWSが提供しているAWSサービス毎のIPレンジリストを取得できるが、その中にCWL Group用のIPプレフィックスは存在しない。  


考えられる対応②  
```
CWL Group用のVPCエンドポイントを作成し、セキュリティグループを付与する
```
以下の手順を実施する  
- セキュリティグループ①を作成  
- VPCエンドポイントを作成し、対象のインスタンスと同様のVPC、サブネットを選択
  また、セキュリティグループ①を選択する。
- インスタンス用セキュリティグループ②のアウトバウンドルールで、セキュリティグループ①への送信を許可
- セキュリティグループ②のインバウンドルールでセキュリティグループ①を許可

上記により、CloudWatch Logsへのログの保存が可能になる。